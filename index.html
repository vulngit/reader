<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPUB Reader</title>

  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      transition: background 0.2s ease, color 0.2s ease;
    }

    body.dark {
      background: #050509;
      color: #f5f5f5;
    }

    body.light {
      background: #f5f5f5;
      color: #111111;
    }

    /* Top bar */
    #topbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(0,0,0,0.2);
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
      z-index: 20;
    }

    body.dark #topbar {
      background: #111320;
      border-bottom-color: #20263a;
    }

    body.light #topbar {
      background: #ffffff;
      border-bottom-color: #dddddd;
    }

    .btn {
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    body.dark .btn {
      background: #222845;
      color: #f5f5f5;
    }

    body.light .btn {
      background: #e5e7ff;
      color: #111111;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    #filePicker {
      font-size: 0.8rem;
    }

    #status {
      margin-left: auto;
      font-size: 0.78rem;
      opacity: 0.7;
      white-space: nowrap;
    }

    #controls-group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    label.small-label {
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #fontSizeRange {
      width: 90px;
    }

    /* Main reader area */
    #reader-container {
      flex: 1;
      min-height: 0;
      position: relative;
      display: flex;
    }

    #viewer {
      flex: 1;
      height: 100%;
      background: transparent;
      overflow: hidden; /* the iframe handles scrolling */
      position: relative;
      z-index: 1;
    }

    body.dark #viewer {
      background: #050509;
    }

    body.light #viewer {
      background: #ffffff;
    }

    #viewer iframe {
      width: 100% !important;
      height: 100% !important;
      border: none;
    }

    #drop-hint {
      position: absolute;
      inset: 40px;
      border: 2px dashed rgba(120, 130, 200, 0.7);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      font-size: 0.95rem;
      pointer-events: none;
      z-index: 2;
    }

    body.dark #drop-hint {
      color: #aab1ff;
      border-color: #353b5c;
      background: rgba(8, 10, 30, 0.7);
    }

    body.light #drop-hint {
      color: #333a88;
      border-color: #a7b0ff;
      background: rgba(255, 255, 255, 0.7);
    }

    select, input[type="range"] {
      font-size: 0.75rem;
    }

    /* TOC (chapters) panel */
    #tocPanel {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 260px;
      max-width: 80%;
      transform: translateX(-100%);
      transition: transform 0.2s ease;
      z-index: 10;
      overflow-y: auto;
      padding: 10px;
      border-right: 1px solid rgba(0,0,0,0.2);
    }

    body.dark #tocPanel {
      background: #0b0d20;
      color: #f5f5f5;
      border-right-color: #20263a;
    }

    body.light #tocPanel {
      background: #ffffff;
      color: #111111;
      border-right-color: #dddddd;
    }

    #tocPanel.open {
      transform: translateX(0);
    }

    #tocTitle {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 6px;
      opacity: 0.8;
    }

    #tocList {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.85rem;
    }

    .toc-item {
      padding: 6px 4px;
      border-radius: 4px;
      cursor: pointer;
    }

    body.dark .toc-item {
      color: #e2e6ff;
    }

    body.light .toc-item {
      color: #222c6c;
    }

    .toc-item:hover {
      background: rgba(120, 130, 200, 0.15);
    }

    /* Side page arrows */
    .page-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      cursor: pointer;
      user-select: none;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 5;
    }

    #nav-left {
      left: 12px;
    }

    #nav-right {
      right: 12px;
    }

    body.dark .page-arrow {
      background: rgba(9, 11, 40, 0.85);
      color: #f5f5f5;
      box-shadow: 0 0 10px rgba(0,0,0,0.65);
    }

    body.light .page-arrow {
      background: rgba(255, 255, 255, 0.9);
      color: #111;
      box-shadow: 0 0 10px rgba(0,0,0,0.35);
    }

    .page-arrow.visible {
      opacity: 0.85;
      pointer-events: auto;
    }

    .page-arrow:hover {
      transform: translateY(-50%) scale(1.05);
      opacity: 1;
    }
  </style>
</head>
<body class="dark">
  <div id="topbar">
    <button id="tocToggle" class="btn">☰ Chapters</button>

    <input type="file" id="filePicker" accept=".epub" />

    <button id="themeToggle" class="btn">Dark mode</button>

    <div id="controls-group">
      <label class="small-label">
        Font:
        <select id="fontSelect">
          <option value="system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">Default</option>
          <option value="Georgia, 'Times New Roman', serif">Serif</option>
          <option value="Arial, Helvetica, sans-serif">Sans</option>
          <option value="'OpenDyslexic', system-ui, sans-serif">Dyslexic (if installed)</option>
        </select>
      </label>

      <label class="small-label">
        Size:
        <input type="range" id="fontSizeRange" min="80" max="180" value="100" />
        <span id="fontSizeLabel">100%</span>
      </label>
    </div>

    <span id="status">Choose or drag & drop an EPUB…</span>
  </div>

  <div id="reader-container">
    <!-- TOC / chapter list -->
    <aside id="tocPanel">
      <div id="tocTitle">Chapters</div>
      <ul id="tocList"></ul>
    </aside>

    <div id="viewer"></div>

    <div id="drop-hint">
      Drop an EPUB anywhere. Scroll inside each chapter. Use side arrows or chapters menu to navigate.
    </div>

    <!-- Left/right navigation arrows -->
    <div id="nav-left" class="page-arrow">&#10094;</div>
    <div id="nav-right" class="page-arrow">&#10095;</div>
  </div>

  <!-- JSZip required by EPUB.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- EPUB.js -->
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <script>
    let book = null;
    let rendition = null;
    let currentLocation = null;

    let currentTheme = "dark";
    let currentFontFamily = "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
    let currentFontSize = 100; // %

    const viewer = document.getElementById("viewer");
    const picker = document.getElementById("filePicker");
    const statusEl = document.getElementById("status");
    const hint = document.getElementById("drop-hint");
    const themeToggle = document.getElementById("themeToggle");
    const fontSelect = document.getElementById("fontSelect");
    const fontSizeRange = document.getElementById("fontSizeRange");
    const fontSizeLabel = document.getElementById("fontSizeLabel");

    const tocToggle = document.getElementById("tocToggle");
    const tocPanel = document.getElementById("tocPanel");
    const tocList = document.getElementById("tocList");

    const navLeft = document.getElementById("nav-left");
    const navRight = document.getElementById("nav-right");

    let tocOpen = false;
    let bookLoaded = false;

    function setStatus(msg) {
      statusEl.textContent = msg;
      console.log(msg);
    }

    // Styles applied inside the EPUB iframe
    function generateThemeStyles() {
      const isDark = currentTheme === "dark";
      const bg = isDark ? "#050509" : "#ffffff";
      const text = isDark ? "#f5f5f5" : "#111111";

      return {
        "html": {
          "background": bg
        },
        "body": {
          "background": bg,
          "color": text,
          "font-family": currentFontFamily,
          "font-size": currentFontSize + "%",
          "line-height": "1.6",
          "margin": "1.5em 8%",
          "overflow-y": "auto"
        },
        "img": {
          "max-width": "40%",   // WAY smaller images
          "height": "auto",
          "display": "block",
          "margin": "1em auto"
        }
      };
    }

    function applyReaderStyles() {
      if (!rendition) return;
      const styles = generateThemeStyles();
      rendition.themes.default(styles);

      const target =
        currentLocation?.start?.cfi ||
        currentLocation?.cfi ||
        undefined;

      if (target) {
        rendition.display(target);
      } else {
        rendition.display();
      }
    }

    function toggleToc(openExplicit) {
      if (!bookLoaded) return;
      if (typeof openExplicit === "boolean") {
        tocOpen = openExplicit;
      } else {
        tocOpen = !tocOpen;
      }
      if (tocOpen) {
        tocPanel.classList.add("open");
      } else {
        tocPanel.classList.remove("open");
      }
    }

    async function loadBook(file) {
      if (!file) return;

      try {
        setStatus("Loading " + file.name + " ...");
        const buffer = await file.arrayBuffer();

        if (book) {
          try { book.destroy(); } catch (err) {}
        }

        book = ePub(buffer);

        // Scroll inside each chapter/section
        rendition = book.renderTo("viewer", {
          width: "100%",
          height: "100%",
          flow: "scrolled-doc",
          spread: "none"
        });

        rendition.on("relocated", (location) => {
          currentLocation = location;
        });

        // Apply initial styles
        rendition.themes.default(generateThemeStyles());
        await rendition.display();

        // Load TOC (chapters) and build menu
        try {
          const nav = await book.loaded.navigation;
          const toc = nav.toc || [];
          tocList.innerHTML = "";

          toc.forEach((item) => {
            const li = document.createElement("li");
            li.className = "toc-item";
            li.textContent = item.label || item.label?.trim() || "Untitled section";
            li.addEventListener("click", () => {
              rendition.display(item.href);
              toggleToc(false);
            });
            tocList.appendChild(li);
          });

        } catch (navErr) {
          console.warn("Failed to load TOC:", navErr);
          tocList.innerHTML = "<li style='font-size:0.8rem;opacity:0.7;'>No TOC available</li>";
        }

        hint.style.display = "none";
        bookLoaded = true;

        // Show side arrows when a book is loaded
        navLeft.classList.add("visible");
        navRight.classList.add("visible");

        setStatus("Loaded: " + file.name);
      } catch (err) {
        console.error(err);
        alert("Failed to load EPUB: " + err.message);
        setStatus("Error loading book");
      }
    }

    picker.addEventListener("change", e => {
      const file = e.target.files[0];
      loadBook(file);
    });

    document.addEventListener("dragover", e => {
      e.preventDefault();
    });

    document.addEventListener("drop", e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file && file.name.toLowerCase().endsWith(".epub")) {
        loadBook(file);
      } else {
        alert("Please drop a valid .epub file.");
      }
    });

    // Side arrows => move between chapters/sections
    navLeft.addEventListener("click", () => {
      if (rendition) rendition.prev();
    });
    navRight.addEventListener("click", () => {
      if (rendition) rendition.next();
    });

    // Keyboard navigation: left/right switch sections
    document.addEventListener("keydown", (e) => {
      if (!rendition) return;
      if (e.key === "ArrowRight" || e.key === "PageDown") {
        e.preventDefault();
        rendition.next();
      } else if (e.key === "ArrowLeft" || e.key === "PageUp") {
        e.preventDefault();
        rendition.prev();
      }
      // Space = normal browser scroll inside the chapter
    });

    // Theme toggle
    themeToggle.addEventListener("click", () => {
      currentTheme = currentTheme === "dark" ? "light" : "dark";
      document.body.classList.remove("dark", "light");
      document.body.classList.add(currentTheme);

      themeToggle.textContent = currentTheme === "dark" ? "Dark mode" : "Light mode";
      applyReaderStyles();
    });

    // Font settings
    fontSelect.addEventListener("change", () => {
      currentFontFamily = fontSelect.value;
      applyReaderStyles();
    });

    fontSizeRange.addEventListener("input", () => {
      currentFontSize = parseInt(fontSizeRange.value, 10);
      fontSizeLabel.textContent = currentFontSize + "%";
      applyReaderStyles();
    });

    // TOC toggle button
    tocToggle.addEventListener("click", () => {
      toggleToc();
    });

    // Default theme class
    document.body.classList.add(currentTheme);
  </script>
</body>
</html>
